---
title: 部署相关小记
date: 2019-06-20 00:39:00
categories: [运维]
tags: [Linux,java,https]
description: "易错点，重点笔记"
cover_picture: http://oss.willhappy.cn/hexo/cover_pic/cover_picture_34.jpg

---

  一次项目分布式部署，遇到相关问题的总结笔记。

<!--more-->

[toc]

服务器结构图：

![2019-9-5-23-35-15.png](http://oss.willhappy.cn/hexo/img/2019-9-5-23-35-15.png-willhappy)

## springboot jar启动应用

这个主要是在部署上层业务平台时遇到配置文件反复修改时需要重新打包，比较麻烦，所以建议，将配置文件外置，可直接服务器上修改。

### 配置文件加载顺序、原则

SpringBoot项目启动会去扫描以下目录位置的application.yml或application.properties配置文件来加载bean。

**配置文件优先级从高到低：**

1. file:./config/  - 优先级最高（项目根路径下的config，即和jar包同级目录的/config/）
2. file:./  - 优先级第二  -（项目根路径下, 即jar包所在目录）
3. classpath:/config/  - 优先级第三（项目resources/config下，即jar包内/classes/config/）
4. classpath:/  - 优先级第四（项目resources根目录, 即jar包内/classes/）

```js
---
  |-- springboot-demo.jar
     |-- BOOT-INF
        |-- classes
          |-- config
            |-- ③application.yml
          |-- ④application.yml
  |-- config
     |-- ①application.yml
  |-- ②application.yml
```

**原则：**

- `高优先级`配置会覆盖`低优先级`配置
- 多个配置文件`互补`

**小总结：**

使用：

```shell
> java -jar demo.jar --spring.config.location=/opt/config/application.properties
```

使用命令指定jar外部的配置文件或者直接配置jar包的配置文件，可以在测试或生产环境中快速地修改配置参数值，而不需要重新打包和部署应用。

**另安利几篇干货：**

- [官方springboot配置api][1]
- [Spring Boot 多环境配置最佳实践][2]
- [Spring Boot 2.x基础教程：配置文件详解][3]
- [史上最全的Spring Boot配置文件详解][4]

## 内网服务器间共享挂载

要实现集群之间共享的文件（静态资源）的操作，可以通过挂载方式实现。即将共享文件统一放到一台共享文件的服务器上，通过挂载的形式，访问这些共享文件。
具体实现操作，参考[文章][5]

使用到的命令：

```shell
// 查看磁盘挂载情况
$ df –h

// 挂载
$ mount ­t nfs 192.168.0.199:/upload /home/web/upload

// 取消挂载
$ umount /home/web/upload
```

## https混合http请求的问题

这个问题是在视频都是使用http的，当https网站去使用http请求拉流时出现，出报错。
![2019-9-7-13-44-35.png](http://oss.willhappy.cn/hexo/img/2019-9-7-13-44-35.png-willhappy)

像这种，HTTPS页面混合不安全的HTTP请求，如何解决呢？那就是把不安全的http请求升级为https请求。
方法参考[文章][6]

## cdn防盗链拦截静态资源

这个是在使用`cdn`中，去拉取`flash`资源存在跨域，会触发请求跨域策略文件`crossdomain.xml`的情况, 而在请求类似这种静态资源时，cdn如果设置了比较高级的防盗链措施，则这种请求会被拦截掉，所以，解决方案就是，在`cdn防盗链`配置中过滤掉对这种文件的拦截，这样就可以正常的请求到flash资源了。

## 进程管理Supervisor使用

`Supervisor`是一个客户端/服务器系统，采用 `Python(2.4+)` 开发的，它是一个允许用户管理，基于 `Unix` 系统进程的 `Client/Server` 系统，提供了大量功能来实现对进程的管理。

### 安装和基本使用

```shell
// 安装
$ yum install supervisor

// 启动并设置开机自启
$ systemctl start supervisord.service
$ systemctl enable supervisord.service

```

### 应用配置

yum安装完成之后，会生成`/etc/supervisord.conf`主配置文件和一个`/etc/supervisord.d` 自配置文件目录.

(1) 我们可以先在自定义配置目录创建两个文件夹`conf`和`log`来存放我们各个应用的配置和日志。

```shell
// 创建文件夹
$ cd /etc/supervisord.d && mkdir conf log

// 比如创建一个manager.conf的配置
$ cd /etc/supervisord.d/conf
$ vim manager.conf
```

(2) 各应用配置自定义配置

我们现在创建一个使用springboot构建的java应用配置。

```shell
[program:manager]
directory = /home/web ; 程序的启动目录
command = java -jar manager.jar ; 启动命令，与命令行启动的命令是一样的
autostart = true     ; 在 supervisord 启动的时候也自动启动
startsecs = 5        ; 启动 5 秒后没有异常退出，就当作已经正常启动了
autorestart = true   ; 程序异常退出后自动重启
startretries = 3     ; 启动失败自动重试次数，默认是 3
user = root          ; 用哪个用户启动
redirect_stderr = true  ; 把 stderr 重定向到 stdout，默认 false
stdout_logfile_maxbytes = 20MB  ; stdout 日志文件大小，默认 50MB
stdout_logfile_backups = 20     ; stdout 日志文件备份数
; stdout 日志文件，需要注意当指定目录不存在时无法正常启动，所以需要手动创建目录（supervisord 会自动创建日志文件）
stdout_logfile = /etc/supervisord.d/log/manager.log  ;日志统一放在log目录下
; 可以通过 environment 来添加需要的环境变量，一种常见的用法是修改 PYTHONPATH
; environment=PYTHONPATH=$PYTHONPATH:/path/to/somewhere
```

当然，这都是一些我们基本的配置，更多配置，我们可以在[官网][7]查看。

(3) 修改主配置文件

修改主配置文件，使其包含我们自定义的应用配置文件。

```shell
$ vim /etc/supervisord.conf   在最后一行
[include]
files = supervisord.d/conf/*.conf
```

(4) 加载自定义配置文件使其生效

```shell
// 重新加载配置文件
$ supervisorctl reread

// 将配置文件里新增的子进程加入进程组，如果设置了autostart=true则会启动新新增的子进程
$ supervisorctl update
```

其他常用命令：

```shell
// other
$ supervisorctl status
$ supervisorctl stop <program_name>
$ supervisorctl start <program_name>
$ supervisorctl restart <program_name>
$ supervisorctl remove <program_name>
```

当然，也可以输入命令 `supervisorctl` 进入 `supervisorctl` 的 `shell` 交互界面（还是纯命令行😓），就可以在下面输入命令了。

参考文章：

- [官网][7]
- [Supervisor 为服务创建守护进程][8]
- [Supervisor使用教程][9]
- [Spring Boot 项目自动发布与Supervisor][10]

[1]: https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html
[2]: https://www.infoq.cn/article/Q-ese4CxV2IWmltsJcGX
[3]: http://blog.didispace.com/spring-boot-learning-21-1-3/
[4]: https://www.cnblogs.com/yueshutong/p/10025820.html
[5]: https://my.oschina.net/ManderSY/blog/1576936
[6]: https://zhongwuzw.github.io/2016/12/02/%E8%A7%A3%E5%86%B3https%E6%B7%B7%E5%90%88http%E7%9A%84%E9%97%AE%E9%A2%98/
[7]: http://supervisord.org/
[8]: https://www.cnblogs.com/along21/p/10255681.html
[9]: https://juejin.im/entry/5c1f01616fb9a049cd543042
[10]: https://www.jianshu.com/p/866a755e2c2d
